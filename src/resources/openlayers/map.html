<!-- authors : yves sablonier, pete morgan -->
<!-- Â© 2011, GPLv2 and later -->

<html>
<head>
<link rel="stylesheet" href="theme/default/style.css" type="text/css" />
<!-- <link rel="stylesheet" href="style.css" type="text/css" />-->

<!--<script src="http://maps.google.com/maps/api/js?v=3.5&amp;sensor=false"></script> -->

<!-- for later improvement: add yahoo api -->
<!-- <script src="http://api.maps.yahoo.com/ajaxymap?v=3.0&appid=euzuro-openlayers"></script> -->

<!-- this is our main api -->

<script src="OpenLayers.js"></script>



<style type="text/css">

	/* Style for openlayers fullscreen map */
	body {
		margin: 0;
	}
	#map {
		width: 100%;
		height: 100%;
		
	}
}

</style>
	
<script type="text/javascript">



var aptBounds = {};

var zoom = 2;


var map;
var layer;
var google;
var osmprojection;
var vectorLayer;
var markers;


var planeStyleMap = new OpenLayers.StyleMap({
	externalGraphic: "img/marker-blue.png",
	graphicWidth: 21,
	graphicHeight: 25,
	fillOpacity: 0.85,
	rotation: "${mheading}"
});


var planeMarkersStyle = new OpenLayers.StyleMap({
    
    "default": {

        strokeColor: "lime",
        strokeWidth: 1,
        fillColor: "lime",
		
		externalGraphic: "/img/fgx-plane-green.png",
		graphicWidth: 48,
		graphicHeight: 48,
        
        
        fontColor: "black",
        fontSize: "12px",
        fontFamily: "Helvetica, Arial, sans-serif",
        fontWeight: "bold",
        //labelAlign: "center",
        //labelXOffset: 10,
        //labelYOffset: 10,
        label : "${callsign}",
		rotation : "${planerotation}",

        },
    
    "select": {
        fillColor: "black",
        strokeColor: "yellow",
        pointRadius: 12,
        fillOpacity: 1,
    }

});

var rwyMarkersStyle = new OpenLayers.StyleMap({
    
    "default": {

        strokeColor: "lime",
        strokeWidth: 1,
        fillColor: "lime",
		
		externalGraphic: "/img/rwy_sign_back.png",
		graphicWidth: 30,
		graphicHeight: 22,
		
        
        
        fontColor: "white",
        fontSize: "13px",
        fontFamily: "Helvetica, Arial, sans-serif",
        fontWeight: "bold",
        //labelAlign: "center",
        labelXOffset: -15,
        labelYOffset: 18,
        label : "${rwyText}",
		graphicOpacity: 1.0,
		graphicXOffset: -30,
		graphicYOffset: -30

        },
    
    "select": {
        fillColor: "black",
        strokeColor: "yellow",
        pointRadius: 12,
        fillOpacity: 1,
    }

});


var rwyLineStyle = new OpenLayers.StyleMap({
    
    "default": {
        strokeColor: "blue",
        strokeWidth: 8,
		strokeOpacity: 0.9,
        fillColor: "black",
        fillOpacity: 0.9,
		strokeLinecap: "butt"
        },
    
    "select": {
        strokeColor: "yellow",
        fillColor: "yellow",
        }

});


var planes;
var aircraft = {};



function on_map_click(e){
	var lonlat = map.getLonLatFromViewPortPx(e.xy);
	Qt.map_click(lonlat.lat, lonlat.lon);
}

function on_map_mousemove(e){
	var lonlat = map.getLonLatFromViewPortPx(e.xy);
	Qt.map_mouse_move(lonlat.lat, lonlat.lon);
}

function init(){

	map = new OpenLayers.Map('map', {
				controls:[
					new OpenLayers.Control.Navigation(),
					new OpenLayers.Control.Attribution(),
					] 
				} 
			);
	
	 var renderer = OpenLayers.Util.getParameters(window.location.href).renderer;
     renderer = (renderer) ? [renderer] : OpenLayers.Layer.Vector.prototype.renderers;


	layer = new OpenLayers.Layer.OSM("OSM Map");
	map.addLayer(layer);



	// set osm projection
	osmprojection = new OpenLayers.Projection("EPSG:4326");

	//map.addLayer(layer);
	map.setCenter(
		new OpenLayers.LonLat(0, 0).transform(
			osmprojection,
			map.getProjectionObject()
			), zoom
	);

	// map events
	map.events.register("click", map, on_map_click);
	map.events.register("mousemove", map, on_map_mousemove);
	

	
	// add rwy lines
	runwayLines = new OpenLayers.Layer.Vector("Runway Lines", {styleMap:  rwyLineStyle});
	map.addLayer(runwayLines);
	
	
	// add rwy markers
	//rwyMarkers = new OpenLayers.Layer.Markers("Runways Markers",	{styleMap:  rwyMarkersStyle});
	//map.addLayer(rwyMarkers);
	//rwyMarkers.setOpacity(1.0);
	
	rwyMarkers = new OpenLayers.Layer.Vector("Runway Markers", {styleMap:  rwyMarkersStyle});
	map.addLayer(rwyMarkers);
	
	// add plane vector marker
	planeMarkersVec = new OpenLayers.Layer.Vector("Plane Markers", {styleMap:  planeMarkersStyle});
	map.addLayer(planeMarkersVec);


	//alert("init done");

}


//==========================================================
function focus_aircraft(callsign){
	alert(aircraft[callsign].lonlat);
	//map.setCenter(
	//	aircraft[callsign].getCenterLonLat().transform(
	//		osmprojection,
	//		map.getProjectionObject()
	//		), 12
	//);
	//alert(callsign);

}


// Standard OpenLayers marker, not in use
//==========================================================
function add_marker(mlat, mlon){

	var lonlat = new OpenLayers.LonLat(mlon, mlat).transform(osmprojection, map.getProjectionObject());
	var marker = new OpenLayers.Marker(lonlat);
	markers.addMarker(marker);
	return;
	
}


//==========================================================
function show_aircraft(mcallsign, mlat, mlon, mheading, maltitude){

	//destroy features first
	planeMarkersVec.destroyFeatures();

	//add point = coords from airport tab
	var point = new OpenLayers.Geometry.Point(mlon, mlat).transform(osmprojection, map.getProjectionObject() );
		
	//draw feature and add callsign label, use rwy heading for orientation
	var feature = new OpenLayers.Feature.Vector(point, {
                callsign: mcallsign,
				planerotation: mheading
				});            
	
	//add to main layer planeMarkersVec at init()
	planeMarkersVec.addFeatures([feature]);

	return;
	
}

//==========================================================
function add_rwymarker(mrwy, mlat, mlon){

	//add point = coords from airport tab
	var point = new OpenLayers.Geometry.Point(mlon, mlat).transform(osmprojection, map.getProjectionObject() );
		
	//draw feature and add callsign label, use rwy heading for orientation
	var feature = new OpenLayers.Feature.Vector(point, {
                rwyText: mrwy
				});            
	
	//add to main layer planeMarkersVec at init()
	rwyMarkers.addFeatures([feature]);

	return;
	
}


//==========================================================
function zoom_to_airport(apt){
	//alert(markers.getDataExtent());
	//map.zoomToExtent(aptBounds[apt]);
	//return;
	map.setCenter(
		aptBounds[apt].getCenterLonLat().transform(
			osmprojection,
			map.getProjectionObject()
			), 12
	);

}

//==========================================================
function zoom_to(lat, lon, zoom){
	var lonlat = new OpenLayers.LonLat(lon, lat).transform(osmprojection, map.getProjectionObject());
	map.setCenter(lonlat, zoom);
	//alert("xoom");
}


//======================================================
// Add_runway
//======================================================
function add_runway(apt, rwy1, rwy2, lat1, lon1, lat2, lon2){
	
	if( !aptBounds[apt] ){
		aptBounds[apt] = new OpenLayers.Bounds();
		//alert("new bounds");
	}
	aptBounds[apt].extend( new OpenLayers.LonLat(lon1, lat1) );
	aptBounds[apt].extend( new OpenLayers.LonLat(lon2, lat2) );
    
	add_rwymarker(rwy1, lat1, lon1);
	add_rwymarker(rwy2, lat2, lon2);
	var points = new Array(
		new OpenLayers.Geometry.Point(lon1, lat1),
		new OpenLayers.Geometry.Point(lon2, lat2)
	);
	var line = new OpenLayers.Geometry.LineString(points).transform(osmprojection,map.getProjectionObject());
	var runwayFeature = new OpenLayers.Feature.Vector(line);
	runwayLines.addFeatures(runwayFeature);



	//alert("add_runway");
}


</script>


</head>
<body onLoad="init()">
	<div id="map"></div>
</body>

</html>
