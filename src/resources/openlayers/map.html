<!-- author: yves sablonier, zurich -->
<!-- Â© 2011, GPLv2 and later -->

<html>
<head>
<link rel="stylesheet" href="theme/default/style.css" type="text/css" />
<!-- <link rel="stylesheet" href="style.css" type="text/css" />-->

<!-- for later improvement: add yahoo api -->
<!-- <script src="http://api.maps.yahoo.com/ajaxymap?v=3.0&appid=euzuro-openlayers"></script> -->

<!-- this is our main api -->

<script src="OpenLayers.js"></script>



<style type="text/css">

	/* Style for openlayers fullscreen map */
	body {
		margin: 0;
	}
	#map {
		width: 100%;
		height: 100%;
	}

</style>
	
<script type="text/javascript">



/*
 OpenLayers.Control.Hover = OpenLayers.Class(OpenLayers.Control, {                
	defaultHandlerOptions: {
		'delay': 500,
		'pixelTolerance': null,
		'stopMove': false
	},

	initialize: function(options) {
		this.handlerOptions = OpenLayers.Util.extend(
			{}, this.defaultHandlerOptions
		);
		OpenLayers.Control.prototype.initialize.apply(
			this, arguments
		); 
		this.handler = new OpenLayers.Handler.Hover(
			this,
			{'pause': this.onPause, 'move': this.onMove},
			this.handlerOptions
		);
	}, 

	onPause: function(evt) {
		//var output = document.getElementById(this.key + 'Output');
		//var msg = 'pause ' + evt.xy;
		//output.value = output.value + msg + "\r\n";
	},

	onMove: function(evt) {
		// if this control sent an Ajax request (e.g. GetFeatureInfo) when
		// the mouse pauses the onMove callback could be used to abort that
		// request.
	}
});

var control = {
	'long': new OpenLayers.Control.Hover({
		handlerOptions: {
			'delay': 2000
		}
	})
}






*/
//var Qt;


var aptBounds = {};

var zoom = 4;


var map;
var layer;
var osmprojection;
var vectorLayer;
var markers



var layer_style = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
// opacity
layer_style.strokeOpacity = 0.8;
layer_style.fillOpacity = 0.5;

var pointDefaultStyle = OpenLayers.Util.extend({}, layer_style);
pointDefaultStyle.strokeColor = "red";
pointDefaultStyle.fillColor = "red";
pointDefaultStyle.graphicName = "star";
pointDefaultStyle.pointRadius = 10;
pointDefaultStyle.strokeWidth = 4;
pointDefaultStyle.rotation = 45;
pointDefaultStyle.strokeLinecap = "butt";



var planeStyleMap = new OpenLayers.StyleMap({
	externalGraphic: "icons/Garrow360.png",
	graphicWidth: 25,
	graphicHeight: 25,
	fillOpacity: 0.85,
	rotation: "${angle}"
});

var planes = new OpenLayers.Layer.Vector("Planes",{styleMap:planeStyleMap});




function on_map_click(e){
	var lonlat = map.getLonLatFromViewPortPx(e.xy);
	Qt.map_click(lonlat.lat, lonlat.lon);
}

function on_map_mousemove(e){
	var lonlat = map.getLonLatFromViewPortPx(e.xy);
	Qt.map_mouse_move(lonlat.lat, lonlat.lon);
}

function init(){

	map = new OpenLayers.Map('map');
	// alert("init");
	// add OpenStreetMap layer
	layer = new OpenLayers.Layer.OSM( "OSM Map");
	map.addLayer(layer);

	//var urlArray = ["http://tilecache.osgeo.org/wms-c/Basic.py",
	//				"http://tilecache.osgeo.org/wms-c/Basic.py"];
	//layer = new OpenLayers.Layer.WMS( "OpenLayers WMS", 
	//									urlArray,
	//									{layers: 'basic'} );
	//map.addLayer(layer);

	// set osm projection
	osmprojection = new OpenLayers.Projection("EPSG:4326");

	//map.addLayer(layer);
	map.setCenter(
		new OpenLayers.LonLat(0, 0).transform(
			osmprojection,
			map.getProjectionObject()
			), zoom
	);



	//map.addControl(control);
	//map.addControl(new OpenLayers.Control.MousePosition());
	//setting vector layer style


	map.events.register("click", map, on_map_click);
	map.events.register("mousemove", map, on_map_mousemove);

	markers = new OpenLayers.Layer.Markers( "Markers" );
	markers.setOpacity(1.0);
	map.addLayer(markers);


	// adding a vector layer with osm projection
	vectorLayer = new OpenLayers.Layer.Vector("Glyphs", osmprojection);
	map.addLayer(vectorLayer);



	planes = new OpenLayers.Layer.Vector("Planes",	{styleMap:planeStyleMap});
	map.addLayer(planes);

	// drawing a point
	//var point = new OpenLayers.Geometry.Point(5,40).transform(osmprojection,map.getProjectionObject());
	//var feature = new OpenLayers.Feature.Vector(point,null, pointDefaultStyle);
	/*
	var points = new Array(
			new OpenLayers.Geometry.Point(rwyLon1, rwyLat1),
			new OpenLayers.Geometry.Point(rwyLon2, rwyLat2)
			);

	*/
	// add a runway
	/*
	var points = new Array(
			new OpenLayers.Geometry.Point(rwyLon1, rwyLat1),
			new OpenLayers.Geometry.Point(rwyLon2, rwyLat2)
			);
			
	var line = new OpenLayers.Geometry.LineString(points).transform(osmprojection,map.getProjectionObject());
	var runwayFeature = new OpenLayers.Feature.Vector(line,null, pointDefaultStyle);

	// add point to vector layer and to map
	vectorLayer.addFeatures(feature);
	vectorLayer.addFeatures(runwayFeature);
	map.addLayer(vectorLayer);
	*/
	
	//alert("init done");

}

function add_plane(mlat, mlon, angle){
	var feature = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(x, y), {
				angle: angle,
				poppedup: false
			});
	planes.addFeatures([feature]);
}



function add_marker(mlat, mlon){
	//var size = new OpenLayers.Size(21,25);
	//var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
	//var icon = new OpenLayers.Icon('http://www.openlayers.org/dev/img/marker.png', size, offset);
	var lonlat = new OpenLayers.LonLat(mlon, mlat).transform(osmprojection, map.getProjectionObject());
	var marker = new OpenLayers.Marker(lonlat);
	markers.addMarker(marker);
	//alert("y");
	return;
	markers.addMarker(new OpenLayers.Marker(
					new OpenLayers.LonLat(mlon, mlat).transform(osmprojection, map.getProjectionObject() )
					, icon)
	);
	//alert("ere");
}

function zoom_to_airport(apt){
	//alert(markers.getDataExtent());
	//map.zoomToExtent(aptBounds[apt]);
	//return;
	map.setCenter(

		aptBounds[apt].getCenterLonLat().transform(
			osmprojection,
			map.getProjectionObject()
			), 12
	);
}

//======================================================
// Add_runway
//======================================================
function add_runway(apt, lat1, lon1, lat2, lon2){
	
	if( !aptBounds[apt] ){
		aptBounds[apt] = new OpenLayers.Bounds();
		//alert("new bounds");
	}
	aptBounds[apt].extend( new OpenLayers.LonLat(lon1, lat1) );
	aptBounds[apt].extend( new OpenLayers.LonLat(lon2, lat2) );

	add_marker(lat1, lon1);
	add_marker(lat2, lon2);
	var points = new Array(
		new OpenLayers.Geometry.Point(lon1, lat1),
		new OpenLayers.Geometry.Point(lon2, lat2)
	);
	var line = new OpenLayers.Geometry.LineString(points).transform(osmprojection,map.getProjectionObject());
	var runwayFeature = new OpenLayers.Feature.Vector(line,null, pointDefaultStyle);
	vectorLayer.addFeatures(runwayFeature);



	//alert("add_runway");
}


</script>


</head>
<body onload="init()">
	<div id="map"></div>
</body>

</html>
