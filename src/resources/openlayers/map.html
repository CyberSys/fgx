<!-- authors : yves sablonier, pete morgan -->
<!-- Â© 2011, GPLv2 and later -->

<html>
<head>
<!-- this "theme" comes from openlayers. default edited by accident, so it is now FGx default -->
<link rel="stylesheet" href="theme/default/style.css" type="text/css" />

<!-- THIS is our api - currently 2.10 stable -->
<script src="OpenLayers.js"></script>



<style type="text/css">

	/* Style for openlayers fullscreen map */
	body {
		margin: 0;
	}
	#map {
		width: 100%;
		height: 100%;
		
	}
}

</style>
	
<script type="text/javascript">



var aptBounds = {};

var zoom = 2;

// should be improved, setting all the default vars
var map;
var osmprojection;


var osmLayer;

var vectorLayer;
var markers;

var planeMarkersVec;
var planeMarkersLabel;

var radarMarkersVectors;
var radarMarkersLabels;


// click control handler to get lat, lon --> transform values to wgs84
OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
                defaultHandlerOptions: {
                    'single': true,
                    'double': false,
                    'pixelTolerance': 0,
                    'stopSingle': false,
                    'stopDouble': false
                },

                initialize: function(options) {
                    this.handlerOptions = OpenLayers.Util.extend(
                        {}, this.defaultHandlerOptions
                    );
                    OpenLayers.Control.prototype.initialize.apply(
                        this, arguments
                    ); 
                    this.handler = new OpenLayers.Handler.Click(
                        this, {
                            'click': this.trigger
                        }, this.handlerOptions
                    );
                }, 

                trigger: function(e) {
                    var lonlat = map.getLonLatFromViewPortPx(e.xy);
					lonlat.transform(new OpenLayers.Projection("EPSG:900913"), new OpenLayers.Projection("EPSG:4326"));
					Qt.map_click(lonlat.lat, lonlat.lon);
                    //alert("You clicked near " + lonlat.lat + " N, " +
                    //                          + lonlat.lon + " E");
                }
            });

// style for your plane
var planeMarkersStyle = new OpenLayers.StyleMap({
    
    "default": {
		externalGraphic: "/img/fgx-plane-green.png",
		graphicWidth: 48,
		graphicHeight: 48,
		rotation : "${planerotation}",

        },
    
    "select": {
		externalGraphic: "/img/fgx-plane-red.png",
    },

	
});

// style for the marker beside your plane
var planeMarkersLabelStyle = new OpenLayers.StyleMap({
    
    "default": {

        strokeColor: "lime",
        strokeWidth: 1,
        fillColor: "lime",
		
		externalGraphic: "/img/fgx-background-black.png",
		graphicWidth: 66,
		graphicHeight: 18,
		graphicOpacity: 0.9,
		graphicXOffset: 13,
		graphicYOffset: 15,
        
        
        fontColor: "white",
        fontSize: "12px",
        fontFamily: "Helvetica, Arial, sans-serif",
        fontWeight: "bold",
        labelAlign: "left",
        labelXOffset: 16,
        labelYOffset: -24,
        label : "${callsign}",
		//rotation : "${planerotation}",

        },
    
    "select": {
        fillColor: "black",
        strokeColor: "yellow",
        pointRadius: 12,
        fillOpacity: 1,
    }

});


// style for radar plane
var radarMarkersStyle = new OpenLayers.StyleMap({
    
    "default": {

        strokeColor: "lime",
        strokeWidth: 1,
        fillColor: "lime",
		
		externalGraphic: "/img/radar_blip.png",
		graphicWidth: 6,
		graphicHeight: 18,
        graphicOpacity: 1,
		graphicXOffset: 0,
		graphicYOffset: -20,
		//graphicName: "circle",
        
        fontColor: "black",
        fontSize: "12px",
        fontFamily: "Helvetica, Arial, sans-serif",
        fontWeight: "bold",
        //labelAlign: "center",
        //labelXOffset: 10,
        //labelYOffset: 10,
        //label : "${callsign}",
		rotation : "${planerotation}",

        },
    
    "select": {
        fillColor: "black",
        strokeColor: "yellow",
        pointRadius: 12,
        fillOpacity: 1,
    }

});

// style for the marker beside your plane on radar
var radarMarkersLabelStyle = new OpenLayers.StyleMap({
    
    "default": {
		fill: true,
		fillOpacity: 1,
		fillColor: "black",
        strokeColor: "green",
        strokeWidth: 1,

		//graphic: false,
		externalGraphic: "/img/fgx-background-black.png",
		graphicWidth: 50,
		graphicHeight: 12,
		graphicOpacity: 0.6,
		graphicXOffset: 0,
		graphicYOffset: -8,
		
        
        fontColor: "white",
        fontSize: "10px",
        fontFamily: "Helvetica, Arial, sans-serif",
        fontWeight: "bold",
        labelAlign: "left",
        labelXOffset: 2, //16,
        labelYOffset: 2, //-24,
        label : "${callsign}",
		//rotation : "${planerotation}",

    },
    
    "select": {
        fillColor: "black",
        strokeColor: "yellow",
        pointRadius: 12,
        fillOpacity: 1,
    }

});

// style for the rwy markers
var rwyMarkersStyle = new OpenLayers.StyleMap({
    
    "default": {

        strokeColor: "red",
        strokeWidth: 1,
        fillColor: "red",
		
		externalGraphic: "/img/rwy_sign_back.png",
		graphicWidth: 25,
		graphicHeight: 20,
		graphicOpacity: 1.0,
		graphicXOffset: -30,
		graphicYOffset: -30,
		
        
        
        fontColor: "white",
        fontSize: "11px",
        fontFamily: "sans-serif",
        fontWeight: "bold",
        //labelAlign: "center",
        labelXOffset: -15,
        labelYOffset: 18,
        label : "${rwyText}",

        },
    
    "select": {
        fillColor: "black",
        strokeColor: "yellow",
        pointRadius: 12,
        fillOpacity: 1,
    }

});

// style for the rwy lines
var rwyLineStyle = new OpenLayers.StyleMap({
    
    "default": {

        strokeColor: "blue",
        strokeWidth: 8,
        fillColor: "blue",
		strokeOpacity: 0.8,
		strokeLinecap: "butt",
		
        
        
        fontColor: "white",
        fontSize: "13px",
        fontFamily: "Helvetica, Arial, sans-serif",
        fontWeight: "bold",

		graphicOpacity: 1.0,
		graphicXOffset: -30,
		graphicYOffset: -30

        },
    
    "select": {
        fillColor: "black",
        strokeColor: "yellow",
        pointRadius: 12,
        fillOpacity: 1,
    }

});

// oh, see on top
var planes;
var aircraft = {};


// some feedback to qt
/*function on_map_click(e){
	var lonlat = map.getLonLatFromViewPortPx(e.xy);
	Qt.map_click(lonlat.lat, lonlat.lon);
}*/



/*function on_map_mousemove(e){
	var lonlat = map.getLonLatFromViewPortPx(e.xy);
	Qt.map_mouse_move(lonlat.lat, lonlat.lon);
}*/

/*function on_zoom_changed(){
	//alert("ere");
}

function onPopupClose(evt) {
            selectControl.unselect(selectedFeature);
        }
        
function onFeatureSelect(feature) {
            selectedFeature = feature;
            popup = new OpenLayers.Popup.FramedCloud("popup", 
                                     feature.geometry.getBounds().getCenterLonLat(),
                                     null,
                                     "<div style='font-size:.8em'>Feature: " + feature.id +"<br />Area: " + feature.geometry.getArea()+"</div>",
                                     null, true, onPopupClose);
            feature.popup = popup;
            map.addPopup(popup);
        }
		
function onFeatureUnselect(feature) {
            map.removePopup(feature.popup);
            feature.popup.destroy();
            feature.popup = null;
        } */   


// main function
function init(){

	// adds an optional graticule 
	graticule = new OpenLayers.Control.Graticule({
                    numPoints: 2, 
                    labelled: true,
					displayInLayerSwitcher: true,
					labelFormat: "dm",
					layerName: "Grid",
					visible: false,
                })

	// add the main map object
	map = new OpenLayers.Map('map', {
				controls:[
					graticule,
					new OpenLayers.Control.Navigation(),
					new OpenLayers.Control.Attribution(),
					new OpenLayers.Control.LayerSwitcher()
					],
				} 
			);
	
	//=====================
	//= Map events
	/*map.div.oncontextmenu = function noContextMenu(e) {
		if (OpenLayers.Event.isRightClick(e)){
			//alert("Right button click"); // Add the right click menu here
			var lonlat = map.getLonLatFromViewPortPx(e.xy);
			//Qt.map_rightclick(lonlat.lat, lonlat.lon);
			
		}
        return false; //cancel the right click of brower
    }; */

	// map events
	//map.events.register("click", map, on_map_click);
	//map.events.register("rightclick", map, on_map_rightclick);
	//map.events.register("mousemove", map, on_map_mousemove);
	//map.events.register("zoomin", map, on_zoom_changed);
	

	var renderer = OpenLayers.Util.getParameters(window.location.href).renderer;
    renderer = (renderer) ? [renderer] : OpenLayers.Layer.Vector.prototype.renderers;




	osmLayer = new OpenLayers.Layer.OSM("OSM Map");
	map.addLayer(osmLayer);

	//= Zoom changed
	osmLayer.events.on({
		moveend: function(e) {
			if (e.zoomChanged) {
				Qt.map_zoom_changed(map.zoom);
			}
		}
	});

	// Example how to integrate flightgear mapserver layers
	
	/*fgprojection = new OpenLayers.Projection("EPSG:900913");
    
	var fglayer = new OpenLayers.Layer.WMS( "FlightGear Mapserver",
                    "http://mapserver.flightgear.org/ms?",
                    {layers: 'v0_landmass'} );
                    
    
	map.addLayer(fglayer, fgprojection);*/
	

	// set osm projection
	osmprojection = new OpenLayers.Projection("EPSG:4326");
    

	//map.addLayer(layer);
	map.setCenter(
		new OpenLayers.LonLat(0, 0).transform(
			osmprojection,
			map.getProjectionObject()
			), zoom
	);
	
	
	// activate click control
	var click = new OpenLayers.Control.Click();
                map.addControl(click);
                click.activate();


	



	
	//===================================
	// add rwy lines
	runwayLines = new OpenLayers.Layer.Vector("Runway Lines", {styleMap:  rwyLineStyle});
	map.addLayer(runwayLines);
	
	// add rwy markers (labels)
	rwyMarkers = new OpenLayers.Layer.Vector("Runway Markers", {styleMap:  rwyMarkersStyle});
	map.addLayer(rwyMarkers);
	

	//===================================
	// add plane vector marker
	planeMarkersVec = new OpenLayers.Layer.Vector("Plane Markers", {styleMap:  planeMarkersStyle});
	map.addLayer(planeMarkersVec);
	
	var modifyFeature = new OpenLayers.Control.ModifyFeature(planeMarkersVec, {
	mode: OpenLayers.Control.ModifyFeature.DRAG,
	});
	
	map.addControl(modifyFeature);
	modifyFeature.activate();

		
	// add plane label
	planeMarkersLabel = new OpenLayers.Layer.Vector("Plane Label", {styleMap:  planeMarkersLabelStyle});
	map.addLayer(planeMarkersLabel);

	//===================================
	// add Radar vector marker
	radarMarkersVectors = new OpenLayers.Layer.Vector("Radar Markers", {styleMap:  radarMarkersStyle});
	map.addLayer(radarMarkersVectors);
	
	// add Radar label
	radarMarkersLabels = new OpenLayers.Layer.Vector("Radar Label", {styleMap:  radarMarkersLabelStyle});
	map.addLayer(radarMarkersLabels);

	//alert("init done");

}




//==========================================================
function focus_aircraft(callsign){
	alert(aircraft[callsign].lonlat);
	//map.setCenter(
	//	aircraft[callsign].getCenterLonLat().transform(
	//		osmprojection,
	//		map.getProjectionObject()
	//		), 12
	//);
	//alert(callsign);

}


// Standard OpenLayers marker, not in use
//==========================================================
function add_marker(mlat, mlon){

	var lonlat = new OpenLayers.LonLat(mlon, mlat).transform(osmprojection, map.getProjectionObject());
	var marker = new OpenLayers.Marker(lonlat);
	markers.addMarker(marker);
	return;
	
}

// Shows your aircraft on the map, with callsign (two features, poor openlayer)
//==========================================================
function show_aircraft(mcallsign, mlat, mlon, mheading, maltitude){

	//destroy features first
	planeMarkersVec.destroyFeatures();
	planeMarkersLabel.destroyFeatures();

	//add point = coords from airport tab
	var point = new OpenLayers.Geometry.Point(mlon, mlat).transform(osmprojection, map.getProjectionObject() );
	var pointLabel = new OpenLayers.Geometry.Point(mlon, mlat).transform(osmprojection, map.getProjectionObject() );
		
	//draw feature and add callsign label, use rwy heading for orientation
	var feature = new OpenLayers.Feature.Vector(point, {
                //callsign: mcallsign,
				planerotation: mheading
				}); 
				
	// add callsign as separate feature, to have a background color (graphic) with offset
	var callsignFeature = new OpenLayers.Feature.Vector(pointLabel, {
                callsign: mcallsign,
				});
	
	//add the plane
	planeMarkersVec.addFeatures([feature]);
	
	//add the label
	planeMarkersLabel.addFeatures([callsignFeature]);
	return;
	
}

function display_radar(viz){
	radarMarkersVectors.display(viz);
	radarMarkersLabels.display(viz);
}


// Shows aircraft on the RADAR map, with callsign (two features, poor openlayer)
//==========================================================
function show_radar(mcallsign, mlat, mlon, mheading, maltitude){


	var existing_img = radarMarkersVectors.getFeatureBy("_callsign", mcallsign);
	if(existing_img){
		radarMarkersVectors.removeFeatures(existing_img);
	}
	var existing_lbl  = radarMarkersLabels.getFeatureBy("_callsign", mcallsign);
	if(existing_lbl){
		radarMarkersLabels.removeFeatures(existing_lbl);
	}

	//add point 
	var pointImg = new OpenLayers.Geometry.Point(mlon, mlat).transform(osmprojection, map.getProjectionObject() );
	var pointLabel = new OpenLayers.Geometry.Point(mlon, mlat).transform(osmprojection, map.getProjectionObject() );
		
	//draw feature and add callsign label, 
	var imgFeat = new OpenLayers.Feature.Vector(pointImg, {
				planerotation: mheading
				}); 
	imgFeat._callsign = mcallsign;
				
	// add callsign as separate feature, to have a background color (graphic) with offset
	var lblFeat = new OpenLayers.Feature.Vector(pointLabel, {
                callsign: mcallsign,
				});
	lblFeat._callsign = mcallsign;
	
	//add the plane
	radarMarkersVectors.addFeatures([imgFeat]);
	
	//add the label
	radarMarkersLabels.addFeatures([lblFeat]);
	//alert(mcallsign);
	return;
	
}

// Shows available runways
//==========================================================
function add_rwymarker(mrwy, mlat, mlon){

	//add point = coords from airport tab
	var point = new OpenLayers.Geometry.Point(mlon, mlat).transform(osmprojection, map.getProjectionObject() );
		
	//draw feature and add callsign label, use rwy heading for orientation
	var feature = new OpenLayers.Feature.Vector(point, {
                rwyText: mrwy
				});            
	
	//add to main layer planeMarkersVec at init()
	rwyMarkers.addFeatures([feature]);

	return;	
}


// Add Stand
//==========================================================
function add_stand(apt, name, mlat, mlon){

	//add point = coords from airport tab
	var point = new OpenLayers.Geometry.Point(mlon, mlat).transform(osmprojection, map.getProjectionObject() );
		
	//draw feature and add callsign label, use rwy heading for orientation
	var feature = new OpenLayers.Feature.Vector(point, {
                rwyText: name
				});            
	
	//add to main layer planeMarkersVec at init()
	rwyMarkers.addFeatures([feature]);

	return;	
}


//=========================================================
// Zooms to every point you like ...
//==========================================================


//= zoom_to value
function zoom_to(zoom){
	map.zoomTo(zoom);
}

//= zoom to lposition
function zoom_to_latlon(lat, lon, zoom){
	var lonlat = new OpenLayers.LonLat(lon, lat).transform(osmprojection, map.getProjectionObject());
	map.setCenter(lonlat, zoom);
}

// Zooms the map to the airport (thanks, Pete!)
function zoom_to_airport(apt){
	map.setCenter(
		aptBounds[apt].getCenterLonLat().transform(
			osmprojection,
			map.getProjectionObject()
			), 12
	);
}




// Adds runways (line) and markers (point features)
//======================================================
function add_runway(apt, rwy1, rwy2, lat1, lon1, lat2, lon2){
	
	if( !aptBounds[apt] ){
		aptBounds[apt] = new OpenLayers.Bounds();
		//alert("new bounds");
	}
	aptBounds[apt].extend( new OpenLayers.LonLat(lon1, lat1) );
	aptBounds[apt].extend( new OpenLayers.LonLat(lon2, lat2) );
    
	add_rwymarker(rwy1, lat1, lon1);
	add_rwymarker(rwy2, lat2, lon2);
	var points = new Array(
		new OpenLayers.Geometry.Point(lon1, lat1),
		new OpenLayers.Geometry.Point(lon2, lat2)
	);
	var line = new OpenLayers.Geometry.LineString(points).transform(osmprojection,map.getProjectionObject());
	var runwayFeature = new OpenLayers.Feature.Vector(line);
	runwayLines.addFeatures(runwayFeature);



	//alert("add_runway");
}


</script>

<!-- This is all we need, init the map and set only one div, to get fullscreen map -->
</head>
<body onLoad="init()">
	<div id="map"></div>
</body>

</html>
